name: "Rust Bootstrap"
description: "Bootstraps the rust environment"
runs:
  using: "composite"
  steps:
    - name: Set cargo home on linux
      if: runner.os == 'Linux'
      run: echo "cargo_home=$CARGO_HOME" >> $GITHUB_ENV
      shell: bash

    - name: Set cargo home on windows
      if: runner.os == 'Windows'
      run: echo "cargo_home=$env:CARGO_HOME" >> $env:GITHUB_ENV
      shell: powershell

    - name: Cache cargo registry
      uses: actions/cache@v2
      with:
        path: |
          ${{ env.cargo_home }}/registry
          ${{ env.cargo_home }}/git
        key: ${{ runner.os }}-cargo-fetch1-${{ hashFiles('Cargo.lock') }}

    - name: Bootstrap monorepo
      if: runner.os == 'Linux'
      run: |
        echo "::group::Fetch all packages"
        cargo fetch
        echo "::endgroup::"
        echo "::group::Build and run the bootstrap package"
        cargo run -p bootstrap
        echo "::endgroup::"
        echo "::group::Relink monorepo executable"
        cargo m --help
        echo "::endgroup::"
      shell: bash

    - name: Bootstrap monorepo
      if: runner.os == 'Windows'
      run: |
        echo "::group::Fetch all packages"
        cargo fetch
        echo "::endgroup::"
        echo "::group::Build and run the bootstrap package"
        cargo run -p bootstrap
        echo "::endgroup::"
        echo "::group::Relink monorepo executable"
        cargo m --help
        echo "::endgroup::"
      shell: powershell
