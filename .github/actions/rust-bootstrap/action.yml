name: "Rust Bootstrap"
description: "Bootstraps the rust environment"
inputs:
  init:
    required: false
    type: boolean
    default: false
runs:
  using: "composite"
  steps:
    - name: Mirror cargo dependencies
      if: ${{ inputs.init }}
      run: cargo fetcher --include-index --url "https://legionlabs-ci-artefacts.s3-ca-central-1.amazonaws.com/fetch-cache/" mirror
      shell: bash

    - name: Sync cargo dependencies
      run: cargo fetcher --include-index --url "https://legionlabs-ci-artefacts.s3-ca-central-1.amazonaws.com/fetch-cache/" sync
      shell: bash

    - name: Bootstrap monorepo
      if: ${{ inputs.init }}
      run: |
        echo "::group::Build and run the bootstrap package"
        cargo run -p bootstrap
        echo "::endgroup::"
        echo "::group::Copy executables to s3"
        tar -czvf ./target/monorepo.tar.gz --directory ./target/debug monorepo
        aws s3 cp ./target/monorepo.tar.gz s3://legionlabs-ci-artefacts/bootstrap/monorepo-$GITHUB_RUN_ID.tar.gz --region ca-central-1
        echo "::endgroup::"
      shell: bash

    - name: Bootstrap monorepo
      run: |
        aws s3 cp s3://legionlabs-ci-artefacts/bootstrap/monorepo-$GITHUB_RUN_ID.tar.gz ./target/monorepo.tar.gz --region ca-central-1
        tar -xzvf ./target/monorepo.tar.gz --directory ./target
        ./target/monorepo --help
        ./target/monorepo build -plgn-math
        exit 1
      shell: bash
