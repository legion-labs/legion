name: Test

on:
  push:
    branches:
      - test-workers

jobs:
  base_ref_selection:
    name: Base ref selection
    uses: ./.github/workflows/reusable_base_ref_selection.yml
    with:
      caller_event_name: ${{ github.event_name }}

  image_setup:
    name: Image Setup
    uses: ./.github/workflows/reusable_build_env_setup.yml

  change_detection:
    name: Change detection
    needs: [base_ref_selection, image_setup]
    uses: ./.github/workflows/reusable_change_detection.yml
    with:
      base_ref: ${{ needs.base_ref_selection.outputs.base_ref }}
      image: ${{ needs.image_setup.outputs.image }}

  rust:
    name: Rust ecosystem
    if: ${{ fromJSON(needs.change_detection.outputs.cargo_pkgs) }}
    needs: [change_detection, image_setup]
    uses: ./.github/workflows/reusable_rust_ecosystem.yml
    with:
      image: ${{ needs.image_setup.outputs.image }}
      pkgs_arg: ${{ needs.change_detection.outputs.cargo_pkgs_args }}
      deploy: false
    secrets:
      docs-deploy-key: ${{ secrets.DOCS_DEPLOY_KEY }}
