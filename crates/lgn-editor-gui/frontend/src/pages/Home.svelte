<script lang="ts">
  import { Panel } from "@lgn/web-client/src/components/panel";
  import ContextMenu from "@lgn/web-client/src/components/ContextMenu.svelte";
  import Notifications from "@lgn/web-client/src/components/Notifications.svelte";
  import ViewportPanel from "@lgn/web-client/src/components/panel/ViewportPanel.svelte";
  import ModalContainer from "@lgn/web-client/src/components/modal/ModalContainer.svelte";
  import TopBar from "@lgn/web-client/src/components/TopBar.svelte";
  import StatusBar from "@lgn/web-client/src/components/StatusBar.svelte";
  import { getAllResources } from "@/api";
  import PropertyGrid from "@/components/propertyGrid/PropertyGrid.svelte";
  import currentResource from "@/stores/currentResource";
  import HierarchyTreeOrchestrator from "@/stores/hierarchyTree";
  import { ResourceDescription } from "@lgn/proto-editor/dist/resource_browser";
  import contextMenu from "@/stores/contextMenu";
  import allResourcesStore from "@/stores/allResources";
  import viewportOrchestrator from "@/stores/viewport";
  import { onMount } from "svelte";
  import authStatus from "@/stores/authStatus";
  import AuthModal from "@/components/AuthModal.svelte";
  import notifications from "@/stores/notifications";
  import SceneExplorer from "@/components/SceneExplorer.svelte";
  import ResourceBrowser from "@/components/ResourceBrowser.svelte";
  import modal from "@/stores/modal";
  import { Entry } from "@/lib/hierarchyTree";

  const { data: currentResourceData } = currentResource;

  function iconSetter(entry: Entry<ResourceDescription | symbol> | null) {
    if (entry) {
      var type = (entry.item as ResourceDescription).type;
      if (type == "entity") {
        entry.icon = "ic:outline-token";
      } else if (type == "script") {
        entry.icon = "ic:outline-text_snippet";
      } else if (type == "instance") {
        entry.icon = "ic:outline-pages";
      } else if (type == "material") {
        entry.icon = "ic:outline-style";
      } else if (type == "mesh" || type == "model" || type == "gltf") {
        entry.icon = "ic:outline-format-shapes";
      } else if (type == "psd") {
        entry.icon = "ic:outline-image";
      } else if (type == "png") {
        entry.icon = "ic:outline-image";
      } else if (type == "texture") {
        entry.icon = "ic:outline-image";
      }
      if (entry.subEntries) {
        for (var subEntry of entry.subEntries) {
          iconSetter(subEntry);
        }
      }
    }
  }

  const {
    data: allResourcesData,
    error: allResourcesError,
    loading: allResourcesLoading,
  } = allResourcesStore;

  const resourceEntriesOrchestrator =
    new HierarchyTreeOrchestrator<ResourceDescription>();

  const {
    currentlyRenameEntry: currentlyRenameResource,
    entries: resourceEntries,
  } = resourceEntriesOrchestrator;

  let currentResourceDescription: ResourceDescription | null = null;

  $: if ($allResourcesError) {
    reloadResources();
  }

  $: if ($allResourcesData) {
    resourceEntriesOrchestrator.load($allResourcesData, iconSetter);
  }

  onMount(() => {
    reloadResources();

    if ($authStatus && $authStatus.type === "error") {
      modal.open(Symbol.for("auth-modal"), AuthModal, {
        payload: $authStatus.authorizationUrl,
        noTransition: true,
      });
    }
  });

  async function reloadResources() {
    $currentResourceData = null;
    currentResourceDescription = null;
    await allResourcesStore.run(getAllResources);
  }
</script>

<ModalContainer store={modal} />

<ContextMenu store={contextMenu} />

<Notifications store={notifications} />

<div class="root">
  <TopBar />
  <div class="content-wrapper">
    <div class="content">
      <div class="secondary-contents">
        <div class="scene-explorer">
          <SceneExplorer
            allResourcesLoading={$allResourcesLoading}
            resourceEntries={$resourceEntries}
            bind:currentResourceDescription
          />
        </div>
        <div class="h-separator" />
        <div class="resource-browser">
          <ResourceBrowser
            allResourcesLoading={$allResourcesLoading}
            bind:currentResourceDescription
            bind:currentlyRenameResource={$currentlyRenameResource}
            bind:resourceEntries={$resourceEntries}
          />
        </div>
      </div>
      <div class="v-separator" />
      <div class="main-content">
        <ViewportPanel orchestrator={viewportOrchestrator} />
      </div>
      <div class="v-separator" />
      <div class="secondary-contents">
        <div class="property-grid">
          <Panel tabs={["Property Grid"]}>
            <div slot="tab" let:tab>
              {tab}
            </div>
            <div class="property-grid-content" slot="content">
              <PropertyGrid />
            </div>
          </Panel>
        </div>
      </div>
    </div>
  </div>
  <StatusBar />
</div>

<style lang="postcss">
  .root {
    @apply h-screen w-full;
  }

  .root .content-wrapper {
    @apply h-[calc(100vh-4rem)] w-full overflow-auto;
  }

  .content {
    @apply flex flex-row h-full w-full;
  }

  .main-content {
    @apply flex flex-col w-full;
  }

  .v-separator {
    @apply flex-shrink-0 w-1;
  }

  .h-separator {
    @apply flex-shrink-0 h-1;
  }

  .secondary-contents {
    @apply flex flex-col flex-shrink-0 w-96 h-full;
  }

  .scene-explorer {
    @apply h-[calc(50%-theme("spacing[0.5]"))];
  }

  .resource-browser {
    @apply h-[calc(50%-theme("spacing[0.5]"))];
  }

  .property-grid {
    @apply h-full;
  }

  .property-grid-content {
    @apply h-full;
  }
</style>
