openapi: 3.0.3
info:
  title: "Source Control API"
  description: "The OpenAPI specification for the Legion Labs source control API."
  version: 1.0.0

paths:
  /v1/spaces/{space-id}/workspaces/{workspace-id}/contents/upload/:
    parameters:
      - $ref: "../../lgn-governance/apis/space.yaml#/components/parameters/space_id"
      - $ref: "../../lgn-governance/apis/workspace.yaml#/components/parameters/workspace_id"
    post:
      description: Initialize the upload of any content.
      operationId: contentUploadInit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContentUploadInit"
      responses:
        "200":
          description: Ok.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContentUploadInitSucceeded"
        "400":
          description: Upload init failed because the content size is bigger than the accepted size

  /v1/spaces/{space-id}/workspaces/{workspace-id}/contents/upload/{transaction-id}:
    parameters:
      - $ref: "../../lgn-governance/apis/space.yaml#/components/parameters/space_id"
      - $ref: "../../lgn-governance/apis/workspace.yaml#/components/parameters/workspace_id"
      - $ref: "./common.yaml#/parameters/transaction_id"
    put:
      description: Upload chunks of content.
      operationId: contentUpload
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Upload progress.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContentUploadSucceeded"
        "400":
          description: Sent chunk is too big
        "404":
          description: Transaction id not found
    delete:
      description: Cancel content upload.
      operationId: contentUploadCancel
      responses:
        "204":
          description: Upload canceled.
        "404":
          description: Transaction id not found

  /v1/spaces/{space-id}/workspaces/{workspace-id}/staged-resources/:
    parameters:
      - $ref: "../../lgn-governance/apis/space.yaml#/components/parameters/space_id"
      - $ref: "../../lgn-governance/apis/workspace.yaml#/components/parameters/workspace_id"
    get:
      description: Get staged resources.
      operationId: getStagedResources
      responses:
        "200":
          description: Staged resources.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StagedResources"
    post:
      description: Commit the staged resources.
      operationId: commitStagedResources
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommitStagedResources"
      responses:
        "204":
          description: Staged resources committed

  /v1/spaces/{space-id}/workspaces/{workspace-id}/staged-resources/sync-latest/:
    parameters:
      - $ref: "../../lgn-governance/apis/space.yaml#/components/parameters/space_id"
      - $ref: "../../lgn-governance/apis/workspace.yaml#/components/parameters/workspace_id"
    post:
      description: Sync latest.
      operationId: syncLatest
      responses:
        "204":
          description: Synced latest.

  /v1/spaces/{space-id}/workspaces/{workspace-id}/revert-resources/:
    parameters:
      - $ref: "../../lgn-governance/apis/space.yaml#/components/parameters/space_id"
      - $ref: "../../lgn-governance/apis/workspace.yaml#/components/parameters/workspace_id"
    post:
      description: Revert resources.
      operationId: revertResources
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevertResourcesIds"
      responses:
        "204":
          description: Reverted resources.

  /v1/spaces/{space-id}/workspaces/{workspace-id}/properties/{property-id}/pull-assets/:
    parameters:
      - $ref: "../../lgn-governance/apis/space.yaml#/components/parameters/space_id"
      - $ref: "../../lgn-governance/apis/workspace.yaml#/components/parameters/workspace_id"
      - $ref: "#/components/parameters/property_id"
    post:
      description: Pull assets.
      operationId: pullAssets
      responses:
        "200":
          description: Ok.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PullAssetsSucceeded"
        "400":
          description: Property id is invalid
        "404":
          description: Property not found

components:
  parameters:
    property_id:
      name: property-id
      in: path
      description: Property id.
      required: true
      schema:
        $ref: "#/components/schemas/PropertyId"
  schemas:
    PropertyId:
      type: string
    ContentUploadInit:
      type: object
      properties:
        name:
          type: string
        size:
          type: integer
          format: int64
          minimum: 0
      required:
        - name
        - size
    ContentUploadInitSucceeded:
      type: object
      properties:
        id:
          description: The Id of the upload transaction.
          type: string
      required:
        - id
    ContentUploadSucceeded:
      type: object
      properties:
        id:
          description: The Id of the upload transaction.
          type: string
        status:
          type: string
          enum:
            - InProgress
            - Done
        completion:
          type: integer
          format: int32
          minimum: 0
      required:
        - id
        - status
        - completion
    StagedResources:
      type: array
      items:
        $ref: "#/components/schemas/StagedResource"
    StagedResource:
      type: object
      properties:
        info:
          $ref: "common.yaml#/schemas/ResourceDescription"
        change_type:
          type: string
          enum:
            - Add
            - Edit
            - Delete
      required:
        - info
        - change_type
    CommitStagedResources:
      type: object
      properties:
        message:
          type: string
      required:
        - message
    RevertResourcesIds:
      type: array
      items:
        type: string
    PullAssets:
      type: object
      properties:
        id:
          type: string
      required:
        - id
    PullAssetsSucceeded:
      type: object
      properties:
        size:
          type: integer
          format: int32
          minimum: 0
        content:
          type: string
          format: byte
      required:
        - size
        - content
